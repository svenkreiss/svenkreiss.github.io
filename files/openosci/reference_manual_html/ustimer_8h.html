<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenOsci: ustimer.h File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.6 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>ustimer.h File Reference</h1>micro-second(us) timer <a href="#_details">More...</a>
<p>
<code>#include &lt;inttypes.h&gt;</code><br>
<code>#include &lt;avr/io.h&gt;</code><br>
<code>#include &lt;avr/signal.h&gt;</code><br>
<code>#include &lt;avr/interrupt.h&gt;</code><br>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ustimer_8h.html#2719b0c48abedfb52e34e5d8ad1e7410">us_timer_init</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">initiates the timer  <a href="#2719b0c48abedfb52e34e5d8ad1e7410"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">uint32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ustimer_8h.html#535d89455030f2c5b06a0fe7270cfc89">us_time_get</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">get current time  <a href="#535d89455030f2c5b06a0fe7270cfc89"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">uint32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ustimer_8h.html#fff8e579aa19cf42b5ab6eb7f2e4ba19">us_time_get_difference</a> (uint32_t time1)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">calculates the difference between a saved and the current time  <a href="#fff8e579aa19cf42b5ab6eb7f2e4ba19"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ustimer_8h.html#76316e3bffafc95133fa5c6cc1dce463">us_time_get_difference_d</a> (uint32_t time1)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">calculates the difference between a saved and the current time in micro-seconds  <a href="#76316e3bffafc95133fa5c6cc1dce463"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
micro-second(us) timer 
<p>
Functions for precise time measurements. Tested with<ul>
<li>Timer3, ATMega128, 16bit</li><li>Timer1, ATMega16, 16bit</li></ul>
<p>
No tests with 8bit-Timers so far, but it should work with minor changes.<p>
<dl compact><dt><b><a class="el" href="todo.html#_todo000009">Todo:</a></b></dt><dd>ustimer could become a project on its own.</dd></dl>
29 March 2006<br>
 Sven Kreiss <hr><h2>Function Documentation</h2>
<a class="anchor" name="535d89455030f2c5b06a0fe7270cfc89"></a><!-- doxytag: member="ustimer.h::us_time_get" ref="535d89455030f2c5b06a0fe7270cfc89" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">uint32_t us_time_get           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
get current time 
<p>
Calculates the current time from an incremented variable and the counter register of the timer. <div class="fragment"><pre class="fragment"><a name="l00046"></a>00046 {
<a name="l00047"></a>00047     uint16_t timer;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049     <span class="comment">/*  It is really, really important to stop global interrupts before</span>
<a name="l00050"></a>00050 <span class="comment">     *  reading 16bit registers. See the avr-libc FAQ! */</span>
<a name="l00051"></a>00051     cli();
<a name="l00052"></a>00052     timer = TCNT3;
<a name="l00053"></a>00053     sei();
<a name="l00054"></a>00054     
<a name="l00055"></a>00055     <span class="keywordflow">return</span> ((<a class="code" href="ustimer_8c.html#468c797ea2c68c087a393573f2a82cb5">us_time</a> &lt;&lt; 16) + timer);
<a name="l00056"></a>00056 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="fff8e579aa19cf42b5ab6eb7f2e4ba19"></a><!-- doxytag: member="ustimer.h::us_time_get_difference" ref="fff8e579aa19cf42b5ab6eb7f2e4ba19" args="(uint32_t time1)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">uint32_t us_time_get_difference           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">uint32_t&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>time1</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
calculates the difference between a saved and the current time 
<p>
Uses <a class="el" href="ustimer_8c.html#535d89455030f2c5b06a0fe7270cfc89">us_time_get()</a> to get the current time. The if-condition at the end checks whether the later time is smaller. If so, then an timer overflow is assumed and the appropriate action is taken that the correct time can still be calculated. Therefore, the maximum time one can measure is 2^32 micro-seconds. <div class="fragment"><pre class="fragment"><a name="l00068"></a>00068 {
<a name="l00069"></a>00069     uint32_t time2;
<a name="l00070"></a>00070     time2 = <a class="code" href="ustimer_8c.html#535d89455030f2c5b06a0fe7270cfc89">us_time_get</a>();
<a name="l00071"></a>00071     <span class="keywordflow">if</span>(time2 &gt;= time1) <span class="keywordflow">return</span> (time2-time1);
<a name="l00072"></a>00072     <span class="keywordflow">else</span> <span class="keywordflow">return</span> (0xFFFFFFFF - time1+time2); <span class="comment">//2^32</span>
<a name="l00073"></a>00073 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="76316e3bffafc95133fa5c6cc1dce463"></a><!-- doxytag: member="ustimer.h::us_time_get_difference_d" ref="76316e3bffafc95133fa5c6cc1dce463" args="(uint32_t time1)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">double us_time_get_difference_d           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">uint32_t&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>time1</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
calculates the difference between a saved and the current time in micro-seconds 
<p>
Same as <a class="el" href="ustimer_8c.html#fff8e579aa19cf42b5ab6eb7f2e4ba19">us_time_get_difference()</a>, but returns the value in micro seconds. <div class="fragment"><pre class="fragment"><a name="l00079"></a>00079 {
<a name="l00080"></a>00080     <span class="keywordflow">return</span> ((<span class="keywordtype">double</span>)(<a class="code" href="ustimer_8c.html#fff8e579aa19cf42b5ab6eb7f2e4ba19">us_time_get_difference</a>(time1) * US_TIMER_PRESCALER) / (<span class="keywordtype">double</span>)XTAL);
<a name="l00081"></a>00081 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="2719b0c48abedfb52e34e5d8ad1e7410"></a><!-- doxytag: member="ustimer.h::us_timer_init" ref="2719b0c48abedfb52e34e5d8ad1e7410" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void us_timer_init           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
initiates the timer 
<p>
Initiates 16bit-Timer3 for the precise measurement. Enables Timer overflow interrupt.<p>
&lt; for XTAL &gt; 8 MHz: 8, else: 1<p>
&lt; cpu-freq in MHz <div class="fragment"><pre class="fragment"><a name="l00022"></a>00022 {
<a name="l00023"></a>00023 <span class="preprocessor">    #define US_TIMER_PRESCALER 8    </span><span class="comment">///&lt; for XTAL &gt; 8 MHz: 8, else: 1</span>
<a name="l00024"></a>00024 <span class="comment"></span>    #define XTAL 11.0562            <span class="comment">///&lt; cpu-freq in MHz</span>
<a name="l00025"></a>00025 <span class="comment"></span>
<a name="l00026"></a>00026     TCCR3A = 0;                     <span class="comment">//normal mode</span>
<a name="l00027"></a>00027     TCCR3B = (1&lt;&lt;CS31);             <span class="comment">//CS31: Prescaler 8, CS00: Prescaler 1</span>
<a name="l00028"></a>00028     ETIMSK = (1&lt;&lt;TOIE3);            <span class="comment">//enable Timer3 overflow interrupt</span>
<a name="l00029"></a>00029     <span class="comment">//TIMSK = (1&lt;&lt;TOIE1);           //enable Timer1 overflow interrupt</span>
<a name="l00030"></a>00030     TCNT3 = 0;
<a name="l00031"></a>00031 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Fri Aug 11 21:47:33 2006 for OpenOsci by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.6 </small></address>
</body>
</html>
